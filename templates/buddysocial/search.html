{% extends "base.html" %}
{% load static %}

{% block page_title %}
Search
{% endblock page_title %}

{% block contents %}
<body class="overflow-x-hidden bg-canvasColor">
<section class="bg-canvasColor mx-auto w-screen">
    {% include "includes/success_message.html" %}
    {% include "includes/top_nav.html" %}

    <div class="relative flex items-start w-full">

        <div class="hidden lg:flex flex-col gap-4 rounded-lg fixed bg-bgColor items-center justify-start py-10 text-left">
            <a href="{% url "home" %}" class="flex px-8 py-4 rounded-2xl"><i class="fa-solid fa-house" style="color: #ffffff;"></i></a>
            <a href="{% url "write-story" %}" class="flex px-8 py-4 rounded-2xl"><i class="fa-regular fa-pen-to-square" style="color: #ffffff;"></i></a>
            <a href="{% url "chat" %}" class="flex px-8 py-4 rounded-2xl"><i class="fa-regular fa-comment-dots" style="color: #ffffff;"></i></a>
            <a href="{% url "bookmark" %}" class="flex px-8 py-4 rounded-2xl"><i class="fa-regular fa-bookmark" style="color: #ffffff;"></i></a>
            <a href="{% url "profile" profile.user.username %}" class="flex px-8 py-4 rounded-2xl"><i class="fa-regular fa-user" style="color: #ffffff;"></i></a>
            <a href="{% url "setting" %}" class="flex px-8 py-4 rounded-2xl"><i class="fa-solid fa-gear" style="color: #ffffff;"></i></a>
            <a href="{% url "logout" %}" class="flex px-8 py-4 rounded-2xl"><i class="fa-solid fa-arrow-right-from-bracket" style="color: #ffffff;"></i></a>
        </div>

        <div class="flex flex-col gap-6 items-center w-full lg:w-[80vw] p-6 lg:ml-32">
            <div class="flex flex-col w-full lg:w-[70vw] items-center justify-center mx-auto">
                <h2 class="text-white text-center mx-auto text-[1.2rem] font-semibold">Search on BuddyChat</h2>
            </div>
            <form action="" method="get" class="relative flex items-center w-full lg:w-[50vw] mx-auto">
                {% if search_query %}
                <input type="text" placeholder="Search for stories or buddies" name="query" value="{{ search_query }}" class="flex items-center w-full bg-transparent px-10 py-3 border border-textCol text-white rounded-lg focus:border-priColor">
                {% else %}
                <input type="text" placeholder="Search for stories or buddies" name="query" class="flex items-center w-full bg-transparent px-10 py-3 border border-textCol text-white rounded-lg focus:border-priColor">
                {% endif %}
                <i class="fa-solid absolute fa-magnifying-glass px-4" style="color: #ffffff;"></i>
            </form>
            {% if search_query %}
            <!--Search Results-->
            <h2 class="text-white text-[1.2rem] font-light">Search results for <b>{{ search_query }}</b></h2>
            <div class="border-b border-textCol/40 w-full lg:w-[50vw] justify-center flex items-center gap-10">
                <div id="stories-show" class="flex cursor-pointer items-center justify-center text-white border-b border-white py-2 max-w-[10rem]"><p>Stories</span></p></div>
                <div id="buddies-show" class="flex cursor-pointer items-center justify-center text-textCol py-2 max-w-[10rem]"><p>Buddies</span></p></div>
            </div>
            <!--Stories Results-->
            <div id="stories-results" class="flex flex-col mb-20 lg:mb-0 w-full lg:w-[50vw] mx-auto items-center">
                <!--Single post-->
                {% for story in all_stories_for_search %}
                <div class="flex flex-col gap-4 w-full items-start border-t py-4 border-textCol/40 first-of-type:border-0">
                    <div class="flex gap-4 items-center">
                        {% if story.profile.profile.profile_picture %}
                            <a href="{% url "other-users-profile" story.user.username %}"><img src="{{ story.profile.profile_picture.url }}" alt="" srcset="" class="w-[3rem] rounded-full"></a></a>
                            {% else %}
                            <a href="{% url "other-users-profile" story.user.username %}">                            <img src="{% static "images/blank-picture.png" %}" alt="" srcset="" class="w-[3rem] rounded-full"></a></a>
                        {% endif %}
                        <div class="flex flex-col gap-0 md:gap-4 md:flex-row items-start md:items-center">
                            {% if story.profile.display_name %}
                                <h6 class="text-white">{{ story.profile.display_name }}</h6>
                            {% else %}
                                <h6 class="text-white">{{ story.user.username|title }}</h6>
                            {% endif %}
                            <p class="text-textCol">@{{ story.user.username|lower }}</p>
                        </div>
                    </div>
                    <a href="{% url "view-story" username=story.user.username slug=story.slug %}" class="w-full">
                        <div class="flex items-start justify-start w-full text-[#F5F5F5] font-normal">{{ story.contents|linebreaksbr|truncatewords:70 }}</div>
                        <a href="{% url "view-story" username=story.user.username slug=story.slug %}" class="text-[#4707FF] text-sm hover:text-hoverCol transition-colors duration-200">Show more</a>
                    </a>
                    {% if story.story_image %}
                        <img src="{{ story.story_image.url }}" alt="" srcset="" class="w-full max-h-[15rem] md:max-h-[20rem] rounded-lg">
                    {% endif %}
                    <div class="flex items-center justify-between w-full gap-6">
                        <div class="flex items-center gap-6">
                            <a href="{% url "view-story" username=story.user.username slug=story.slug %}" class="flex items-center gap-2 text-textCol text-sm"><i class="fa-regular fa-comment" style="color: #6C757D;"></i> {{ story.number_of_comments }}</a>
                            <form method="POST" id="like-form" class="like-form flex items-center gap-2 text-textCol text-sm">
                                {% csrf_token %}
                                <input type="hidden" class="story-like" name="story-slug" value="{{ story.slug }}">
                                <button id="like-button" class="like-button fa-regular fa-heart text-textCol"></button>
                            </form>
                            {% if story.id in all_bookmarks_id %}
                            <form action="" method="POST" class="flex items-center gap-2 text-textCol text-sm">
                                {% csrf_token %}
                                <input type="hidden" class="bookmark-story-id" name="story-to-remove-id" value="{{ story.id }}">
                                <button class="bookmark-button fa-solid fa-bookmark text-priColor"></button>
                                {{ story.number_of_bookmarks }}
                            </form>
                            {% else %}
                            <form action="" method="POST" class="flex items-center gap-2 text-textCol text-sm">
                                {% csrf_token %}
                                <input type="hidden" class="bookmark-story-id" name="story-to-save-id" value="{{ story.id }}">
                                <button class="bookmark-button fa-regular fa-bookmark text-textCol"></button>
                                {{ story.number_of_bookmarks }}
                            </form>
                            {% endif %}
                        </div>
                        <div class="flex items-center gap-2">
                            <p class=" text-textCol">{{ story.date_created|date:"jS M, f a" }}</p>
                        </div>
                    </div>
                </div>
                {% endfor %}
                <!--End-->
            </div>
            <!--Buddies Search Results-->
            <div id="buddies-search-results" class="hidden flex-col mb-20 lg:mb-0 w-full lg:w-[50vw] mx-auto items-center">
                <div class="flex flex-col items-start w-full lg:w-[50vw]">
                    {% for user in all_users_for_search %}
                    <div class="flex flex-col items-start gap-4 md:gap-10 md:flex-row md:items-center p-4 w-full lg:w-[50vw] border-t border-textCol/40 first-of-type:border-none">
                        <div class="flex gap-4 items-center w-full lg:w-[50vw]">
                            {% if user.profile.profile_picture %}
                                <a href="{% url "other-users-profile" username=user.user.username %}"><img src="{{ user.profile.profile_picture.url }}" alt="" srcset="" class="w-[3rem] rounded-full"></a>
                            {% else %}
                                <a href="{% url "other-users-profile" username=user.user.username %}"><img src="{% static "images/blank-picture.png" %}" alt="" srcset="" class="w-[3rem] rounded-full"></a>
                            {% endif %}
                            <div class="flex flex-col gap-2 items-start w-full ">
                                <div class="flex gap-2 items-start">
                                    {% if user.profile.display_name %}
                                        <h5 class="text-white">{{ user.profile.display_name }}</h5>
                                    {% else %}
                                        <h5 class="text-white">{{ user.user.username|title }}</h5>
                                    {% endif %}
                                    <p class="text-textCol">@{{ user.user.username|title }}</p>
                                </div>
                                    {% if user.bio %}
                                    <p class="text-textCol">{{ user.bio }}</p>
                                    {% endif %}
                            </div>
                        </div>
                        {% if user.id in all_following_id %}
                            <form action="" method="POST" class="w-full md:w-0">
                                {% csrf_token %}
                                <input type="hidden" name="unfollow-id" value="{{ user.id }}">
                                {% if user.user.id != loggedin_user.id %}
                                <button class="flex justify-center w-full md:w-[10rem] follow-btn items-center gap-2 text-white bg-transparent border border-white px-6 py-2 hover:bg-priColor hover:border-none transition duration-200 rounded-lg">Unfollow</button>
                                {% endif %}
                            </form>
                        {% else %}
                             <form action="" method="POST" class="w-full md:w-0">
                                {% csrf_token %}
                                <input type="hidden" name="follow-id" value="{{ user.id }}">
                                {% if user.user.id != loggedin_user.id %}
                                <button class="flex justify-center w-full md:w-[10rem] follow-btn items-center gap-2 text-white hover:bg-transparent hover:border hover:border-white px-6 py-2 bg-priColor transition duration-200 rounded-lg">Follow</button>
                                {% endif %}
                            </form>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
        </div>
    </div>

        </div>
    </div>

    <!--Mobile Nav-->
    <div class="fixed flex gap-6 lg:hidden items-center bottom-0 px-6 py-3 w-full justify-between bg-bgColor/90 rounded-t-xl">
        <a href="{% url "home" %}" class="flex px-4 py-4 rounded-2xl"><i class="fa-solid fa-house" style="color: #ffffff;"></i></a>
        <a href="{% url "write-story" %}" class="flex px-4 py-4 rounded-2xl"><i class="fa-regular fa-pen-to-square" style="color: #ffffff;"></i></a>
        <a href="{% url "chat" %}" class="flex px-4 py-4 rounded-2xl"><i class="fa-regular fa-comment-dots" style="color: #ffffff;"></i></a>
        <a href="{% url "bookmark" %}" class="flex px-4 py-4 rounded-2xl"><i class="fa-regular fa-bookmark" style="color: #ffffff;"></i></a>
    </div>
</section>


<script>
    const stories_menu = document.getElementById('stories-show');
    const buddies_menu = document.getElementById('buddies-show');
    const stories_results = document.getElementById('stories-results');
    const buddies_results = document.getElementById('buddies-search-results');
    buddies_menu.addEventListener('click', switchTab)
    function switchTab() {
        stories_results.classList.remove('flex');
        stories_results.classList.add('hidden');
        buddies_results.classList.remove('hidden');
        buddies_results.classList.add('flex');

        stories_menu.classList.remove('border-b');
        stories_menu.classList.remove('text-white');
        stories_menu.classList.add('text-textCol');
        buddies_menu.classList.add('border-b');
        buddies_menu.classList.remove('text-textCol');
        buddies_menu.classList.add('text-white'); 
    }
    stories_menu.addEventListener('click', switchtoMadeTab)
    function switchtoMadeTab() {
        buddies_results.classList.remove('flex');
        buddies_results.classList.add('hidden');
        stories_results.classList.remove('hidden');
        stories_results.classList.add('flex');

        buddies_menu.classList.remove('border-b');
        buddies_menu.classList.remove('text-white');
        buddies_menu.classList.add('text-textCol');
        stories_menu.classList.add('border-b');
        stories_menu.classList.remove('text-textCol');
        stories_menu.classList.add('text-white'); 
    }
</script>

<script>
    const elements = document.querySelectorAll('.like-button');
    
    elements.forEach((element) => {
      // Your code here
        element.addEventListener('click', changeBtnColor)
        function changeBtnColor(e) {
            
            e.preventDefault()
            element.classList.toggle('text-textCol');
            element.classList.toggle('text-red-500');
            element.classList.toggle('fa-regular');
            element.classList.toggle('fa-solid');
        }

    });

</script>

</body>
{% endblock contents %}